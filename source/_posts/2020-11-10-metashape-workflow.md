---
title: Agisoft photoscan/metashape 使用教程
top: false
cover: false
toc: true
mathjax: false
comment: false
date: 2020-11-10 19:51:49
author:
keywords:
img:
coverImg:
password:
summary:
categories:
tags:
---

Photoscan，新版本改名叫 Metashape 了，相较于 context capture（smart3d）进行空三计算效果更好，速度更快，配置更灵活，空三结果可以导入 context capture 进行三维重建。因此，我经常使用 Metashape 进行空三处理和 DOM 生成，然后再用 cc 进行三维重建，可以显著提高处理速度。而且两个软件都支持集群处理，所需环境保持一致也不会冲突。下面开始作业流程。

## 导入照片，POS，准确性调整

1.如果您在 EXIF 标签中存储了位置精度：
转到“工具”菜单->“首选项...”->“高级”选项卡，然后选中“从 XMP 元数据加载相机位置精度”。 2.在 Metashape 中添加照片：“工作流程”->“添加照片…”。 3.如果是没有 POS 的照片：
导入相机位置。通过单击“参考”窗口中的“导入”按钮导入 POS。确保为文件选择正确的列。如果文件包含角度数据，请选中“加载角度”复选框，然后选择右列。选择存储相机位置的坐标系。如果您有精度估算，也可以加载它们。 4.如果您的相机相对无人机机头存在旋转，则需要在“工具”->“相机校准…”下指定。在“GPS/INS 偏移”标签下，将“偏转（度）”​​ 指定为 90 或您旋转的角度。 5.检查设置。单击“参考”窗口中的“设置”按钮。如果您使用的是方向数据，但尚未导入方向精度，则建议您在不确定是否具有比其更好的精度的情况下，将精度提高到 10-20 度。

## 照片质量

1.Metashape 可以自动估计照片质量。
建议禁用质量值小于 0.5 个单位的图像，并将其排除在摄影测量处理之外。 2.通过在参考窗口中右键单击照片，选择“估计图像质量…”，然后选择“所有相机”，可以估计图像质量。 3.要显示照片的估计图像质量，请在“照片”窗格中将查看模式更改为“详细信息”。 4.您现在可以按“质量”列进行排序。选择质量低于 0.5 的照片并将其禁用。

## 对齐照片

1.对齐您的照片：“工作流程”->“对齐照片…”。将“精度”设置为“高”（只需要 DOM、DSM、DEM，不需要高精度模型的时候，用“低”就完全够了），将“成对预选”设置为“参考”。您也可以使用“最高”，但是会花费更长的时间。阅读手册中的准确度等级是什么意思。可能有必要调整“关键点”和“联系点”限制，以加快处理速度。“自适应相机模型拟合”将使 Metashape 根据其可靠性估算值来选择应包含在调整中的相机参数。 2.对齐完成后，浏览照片，然后依次取消选中和禁用照片块。完成此操作后，运行“优化摄像机…”。勾选：f，cx，cy，k1，k2，k3，p1，p2。 3.在继续之前，请复制您的块。如果在以下步骤中出现问题，则可以返回到副本。 4.使用手动选择工具删除稀疏点云中明显的离群点。然后运行“优化相机…”（勾选：f，cx，cy，k1，k2，k3，p1，p2）。 5.使用“模型”菜单下的“逐步选择...”。向过滤器推荐一定的值是很困难的，最好的方法是遍历这些过滤器以实现误差很小的点云。指定的值应视为建议值，并且取决于数据的质量。使用以下过滤器：

- 图像计数。如果您的数据应该覆盖两张以上的照片（例如，打开的区域和清晰的区域），请使用此选项。然后，您可以使用图像计数=2，对于地面植被比较多的数据，请跳过这一步。使用与以前相同的参数运行“优化摄像机…”。
- 重建不确定性（几何形状）。使用滑块调整合适的值以选择不确定性高的点。推荐值：50 到 25。按 OK，然后按键盘上的 Delete 删除点。使用与以前相同的参数运行“优化摄像机…”。重复至少 2 次。
- 投影精度（像素匹配误差）。使用滑块调整合适的值以选择不确定性高的点。推荐值：10 到 8。按 OK，然后按键盘上的 Delete 删除点。使用与以前相同的参数运行“优化摄像机…”。重复此过滤器和优化过程至少 2 次。
- 选中所有参数后，“优化相机...”。
- 如果您有地面控制点（GCP），请先将其导入，然后再继续进行下一步（重新投影错误）。请参阅下文，了解如何导入 GCP。
- 重投影误差（像素残留误差）。使用滑块调整合适的值以选择不确定性高的点。推荐值：1 到 0.5。按 OK，然后通过按键盘上的 Delete 删除点。选中所有参数，运行“优化摄像机...”。重复至少 2 次。

## 地面控制点（GCP）

仅当您已采集地面控制点时才执行此步骤。 1.如果地面控制点（GCP）与图像位于不同的坐标系中，则现在需要在导入之前将项目转换为与 GCP 相同的坐标系。单击“参考”窗口中的“转换”按钮即可完成此操作。（新版本已经支持照片、地面控制点采用各自独立的坐标系） 2.通过单击“参考”窗口中的“导入”按钮导入 GCP。 3.每个 GCP（甚至照片）的精度可以通过三种不同的方式设置：
x，y 和 z 的精度为 0.1m：0.1。
x 和 y 的精度为 0.1m，z 精度为 0.5m：0.1/0.5。
x 的精度为 0.1m，y 的精度为 0.2m，z 的精度为 0.5m：0.1/0.2/0.5。 4.刺点。您可以右键单击 GCP，然后选择“按选择过滤照片…”。您可以使用“向上翻页”和“向下翻页”键在照片之间切换。将每个标记至少放置在两张照片中。时常运行“优化相机…”以改善未放置标记的位置。
5.“优化相机...”。如果您的 GCP 精度很高，则应先取消选中所有照片，然后再单击“优化相机...”。确保已检查所有要使用的 GCP，并且它们具有正确的精度设置。对于使用 DJI 无人驾驶飞机拍摄的照片，其海拔质量不佳，因此，在运行“优化相机...”并进行处理之前，应始终取消选中照片（至少适用于 2018 年之前的 DJI 无人机）。 6.完成上述步骤后，GCP 中的误差应该很小（如果使用 RTK GNSS 接收器，则误差约为 5-20 厘米）。

## 密集点云和正射照片

1.现在，您可以执行以下命令来执行批处理脚本，也可以一个接一个地运行它们。 2.建立密集的云（如果不进行模型重建可以不进行这一步）。使用“高”质量（很少使用“超高”，因为它需要很长时间，并且通常照片的质量不高。请阅读手册中的更多内容）。将深度过滤设置为“轻微”。 3.构建网格（通常从稀疏云中生成）。 4.平滑网格（工具->网格->平滑网格）。 5.使用稀疏云中的网格创建正射照片。 6.例如，将正照片导出为 tif。

---

_版权声明：_
_除非注明，本博文章均为原创，转载请以链接形式标明本文地址。_

---
